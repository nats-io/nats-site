{{ $desc      := site.Params.description_long | markdownify }}
{{ $companies := site.Data.companies.companies }}

<style>
  /* Industry filter tabs - scrollable on mobile */
  .industry-filters-wrapper {
    position: relative;
    max-width: 100%;
  }

  .industry-filters {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .industry-tab {
    background: transparent;
    border: none;
    color: #a3d4f0;
    cursor: pointer;
    font-weight: bold;
    font-size: 1rem;
    padding: 0.5rem;
    white-space: nowrap;
    transition: color 0.2s ease;
  }

  .industry-tab.active {
    color: #27aae1;
  }

  /* Scroll indicators - hidden by default */
  .scroll-indicator {
    display: none;
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .industry-filters {
      justify-content: flex-start;
      overflow-x: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
      padding: 0.5rem 1rem;
      gap: 1rem;
    }

    .industry-filters::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }

    .industry-tab {
      font-size: 0.9rem;
      padding: 0.5rem 0.25rem;
    }

    /* Fade indicators on edges */
    .industry-filters-wrapper::before,
    .industry-filters-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 24px;
      pointer-events: none;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .industry-filters-wrapper::before {
      left: 0;
      background: linear-gradient(to right, white 0%, transparent 100%);
    }

    .industry-filters-wrapper::after {
      right: 0;
      background: linear-gradient(to left, white 0%, transparent 100%);
    }

    .industry-filters-wrapper.can-scroll-left::before {
      opacity: 1;
    }

    .industry-filters-wrapper.can-scroll-right::after {
      opacity: 1;
    }

    /* Scroll dots indicator */
    .scroll-indicator {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 0.75rem;
    }

    .scroll-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #d0d0d0;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .scroll-dot.active {
      background: #27aae1;
      transform: scale(1.2);
    }

    /* Mobile logo grid: 2-2-1 layout */
    #companies-grid {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0;
    }

    #companies-grid .company-logo {
      width: 50%;
      padding: 0.5rem;
    }

    /* Center the 5th logo (last one in the row) */
    #companies-grid .company-logo.mobile-last {
      width: 50%;
    }

    /* Hide logos beyond 5 on mobile */
    #companies-grid .company-logo.mobile-hidden {
      display: none !important;
    }

    /* Stack CTA buttons vertically on mobile */
    .cta-buttons {
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
    }

    .cta-buttons .button {
      margin: 0 !important;
    }
  }
  /* Intermediate sizes (desktop): force 3-over-2 layout instead of 4-over-1 */
  @media (min-width: 769px) and (max-width: 1215px) {
    #companies-grid {
      justify-content: center !important;
    }
    #companies-grid .company-logo {
      flex: 0 0 33.333% !important;
      max-width: 33.333% !important;
    }
  }

  /* Scale up specific compact logos */
  img[src*="nvidia"], img[src*="replit"], img[src*="capitalone"] {
    transform: scale(1.4);
  }
  img[src*="activision"] {
    transform: scale(2.75);
  }

  /* Scale down specific wide logos */
  img[src*="paloalto"], img[src*="inference"], img[src*="siemens"], img[src*="schaeffler"], img[src*="form3"] {
    transform: scale(0.85);
  }
</style>

<section class="section has-background-white">
  <div class="columns is-centered">
    <div class="column has-text-centered">

        <h2 class="title is-spaced is-size-3 is-size-4-mobile has-text-dark has-text-weight-light">Powering Industry Leaders</h2>

        <!-- Industry filter tabs -->
        <div class="industry-filters-wrapper">
          <div class="industry-filters" id="industry-filters">
            <button class="industry-tab active" data-industry="automotive">Automotive & Industrial</button>
            <button class="industry-tab" data-industry="financial">Financial Services</button>
            <button class="industry-tab" data-industry="telecom">Telecom & Media</button>
            <button class="industry-tab" data-industry="tech">Tech & Cloud</button>
            <button class="industry-tab" data-industry="retail">Retail & Consumer</button>
          </div>
          <div class="scroll-indicator" id="scroll-indicator">
            <span class="scroll-dot active" data-index="0"></span>
            <span class="scroll-dot" data-index="1"></span>
            <span class="scroll-dot" data-index="2"></span>
            <span class="scroll-dot" data-index="3"></span>
            <span class="scroll-dot" data-index="4"></span>
          </div>
        </div>

    </div>
  </div>
  <div class="container">
    <div class="columns is-vcentered is-multiline" id="companies-grid">

          {{ $.Scratch.Set "counter" 0 }}
          {{ range sort $companies "rank" }}
          {{ $img := printf "img/logos/companies/%s" .logo | relURL }}
          {{ $counter := $.Scratch.Get "counter" }}
          {{ $isHidden := ge $counter 25 }}
          {{ $industry := .industry | default "tech" }}
          <div class="column
          is-half-mobile
          is-one-third-tablet
          is-one-quarter-desktop
          is-one-fifth-widescreen
          logo company-logo{{ if $isHidden }} hidden-logo{{ end }}" data-industry="{{ $industry }}" {{ if $isHidden }}style="display: none;"{{ end }}>
<a href="{{ .home }}" target="_blank">
  <img class="is-user-logo" src="{{ $img }}" alt="{{ .name }} logo">
</a>
</div>
          {{ $.Scratch.Add "counter" 1 }}
          {{ end }}
    </div>
    <div class="columns is-centered" style="margin-top: 2rem;">
      <div class="column has-text-centered is-narrow">
        <div class="cta-buttons" style="display: flex; justify-content: center; gap: 1rem;">
          <button id="toggle-logos-btn" class="button is-normal is-link has-text-weight-bold" onclick="toggleLogos()">
            Show All Companies
          </button>
          <a class="button is-normal is-primary has-text-weight-bold" href="https://github.com/nats-io/nats-site#adding-a-company-logo" target="_blank">
            Add Your Company
          </a>
        </div>
      </div>
    </div>
  </div>
  </div>
</section>

<script>
function toggleLogos() {
  const hiddenLogos = document.querySelectorAll('.hidden-logo');
  const button = document.getElementById('toggle-logos-btn');
  const isExpanded = button.getAttribute('data-expanded') === 'true';

  hiddenLogos.forEach(logo => {
    if (isExpanded) {
      logo.style.display = 'none';
    } else {
      logo.style.display = '';
    }
  });

  if (isExpanded) {
    button.textContent = 'Show All Companies';
    button.setAttribute('data-expanded', 'false');
  } else {
    button.textContent = 'Show Less';
    button.setAttribute('data-expanded', 'true');
  }
}

// Industry filter functionality
document.addEventListener('DOMContentLoaded', function() {
  const tabs = document.querySelectorAll('.industry-tab');
  const logos = document.querySelectorAll('.company-logo');
  const filtersContainer = document.getElementById('industry-filters');
  const filtersWrapper = document.querySelector('.industry-filters-wrapper');
  const scrollDots = document.querySelectorAll('.scroll-dot');

  // Update scroll fade indicators
  function updateScrollIndicators() {
    if (!filtersContainer || !filtersWrapper) return;

    const { scrollLeft, scrollWidth, clientWidth } = filtersContainer;
    const canScrollLeft = scrollLeft > 5;
    const canScrollRight = scrollLeft < scrollWidth - clientWidth - 5;

    filtersWrapper.classList.toggle('can-scroll-left', canScrollLeft);
    filtersWrapper.classList.toggle('can-scroll-right', canScrollRight);

    // Update scroll dots based on which tab is most visible
    if (scrollDots.length > 0) {
      const tabElements = Array.from(tabs);
      let closestIndex = 0;
      let closestDistance = Infinity;

      tabElements.forEach((tab, index) => {
        const tabRect = tab.getBoundingClientRect();
        const containerRect = filtersContainer.getBoundingClientRect();
        const tabCenter = tabRect.left + tabRect.width / 2;
        const containerCenter = containerRect.left + containerRect.width / 2;
        const distance = Math.abs(tabCenter - containerCenter);

        if (distance < closestDistance) {
          closestDistance = distance;
          closestIndex = index;
        }
      });

      scrollDots.forEach((dot, index) => {
        dot.classList.toggle('active', index === closestIndex);
      });
    }
  }

  // Scroll to tab when dot is clicked
  scrollDots.forEach(dot => {
    dot.addEventListener('click', function() {
      const index = parseInt(this.getAttribute('data-index'));
      const targetTab = tabs[index];
      if (targetTab && filtersContainer) {
        const containerRect = filtersContainer.getBoundingClientRect();
        const tabRect = targetTab.getBoundingClientRect();
        const scrollOffset = tabRect.left - containerRect.left - (containerRect.width / 2) + (tabRect.width / 2);
        filtersContainer.scrollBy({ left: scrollOffset, behavior: 'smooth' });
      }
    });
  });

  // Listen for scroll events
  if (filtersContainer) {
    filtersContainer.addEventListener('scroll', updateScrollIndicators);
    // Initial check
    setTimeout(updateScrollIndicators, 100);
    window.addEventListener('resize', updateScrollIndicators);
  }

  function filterByIndustry(industry, clickedTab) {
    // Update tab active class
    tabs.forEach(t => {
      t.classList.toggle('active', t.getAttribute('data-industry') === industry);
    });

    // Reset the "Show All Companies" button
    const toggleBtn = document.getElementById('toggle-logos-btn');
    if (toggleBtn) {
      toggleBtn.textContent = 'Show All Companies';
      toggleBtn.setAttribute('data-expanded', 'false');
    }

    const isMobile = window.innerWidth <= 768;
    // Limit to 5 logos on mobile for all categories, and on desktop for tech
    const shouldLimit = isMobile || industry === 'tech';
    let visibleCount = 0;

    // Filter logos
    logos.forEach(logo => {
      // Reset mobile classes
      logo.classList.remove('mobile-visible', 'mobile-hidden', 'mobile-last');

      if (logo.getAttribute('data-industry') === industry) {
        // Limit to 5 logos when applicable
        if (shouldLimit) {
          if (visibleCount < 5) {
            logo.style.display = '';
            logo.classList.add('mobile-visible');
            visibleCount++;
            // Mark the 5th logo as last for centering
            if (visibleCount === 5) {
              logo.classList.add('mobile-last');
            }
          } else {
            logo.style.display = 'none';
            logo.classList.add('mobile-hidden');
          }
        } else {
          logo.style.display = '';
        }
      } else {
        logo.style.display = 'none';
      }
    });

    // Scroll clicked tab into view on mobile
    if (clickedTab && filtersContainer && isMobile) {
      const containerRect = filtersContainer.getBoundingClientRect();
      const tabRect = clickedTab.getBoundingClientRect();
      const scrollOffset = tabRect.left - containerRect.left - (containerRect.width / 2) + (tabRect.width / 2);
      filtersContainer.scrollBy({ left: scrollOffset, behavior: 'smooth' });
    }
  }

  // Track current industry for resize handler
  let currentIndustry = 'automotive';

  // Filter on page load (default to automotive)
  filterByIndustry('automotive', null);

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      currentIndustry = this.getAttribute('data-industry');
      filterByIndustry(currentIndustry, this);
    });
  });

  // Re-apply filter on resize to handle mobile/desktop switching
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      filterByIndustry(currentIndustry, null);
    }, 150);
  });
});
</script>

